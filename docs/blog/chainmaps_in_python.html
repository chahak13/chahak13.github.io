<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2023-04-04 Tue 12:43 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ChainMaps in Python</title>
<meta name="author" content="Chahak Mehta" />
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" href="../style.css" type="text/css"/>
</head>
<body>
<div id="preamble" class="status">
<div id="updated">Updated: 2023-03-25 Sat 20:56</div>
<nav>
<a href="/">Home</a>
<a href="/blog/sitemap.html">Posts</a>
</nav>
</div>
<div id="content" class="content">
<header>
<h1 class="title">ChainMaps in Python</h1>
</header><p>
<kbd>ChainMap</kbd> is a class that provides an interface to quickly link multiple
mappings so that they can be treated as a single unit. For ex., it can act as a
container such that there are two dictionaries, one default and the other that
contains user defined values. This allows easy access to new/old and user
updated values. This note is a simple exploration of the <code>collections.ChainMap</code>
interface.
</p>

<div class="org-src-container">
<pre class="src src-jupyter-python"><span style="color: #89DDFF;">from</span> collections <span style="color: #89DDFF;">import</span> <span style="color: #c792ea;">ChainMap</span>

<span style="color: #ffcb6b;">defaults</span> <span style="color: #89DDFF;">=</span> {<span style="color: #c3e88d;">"color"</span>: <span style="color: #c3e88d;">"red"</span>, <span style="color: #c3e88d;">"user"</span>: <span style="color: #c3e88d;">"guest"</span>, <span style="color: #c3e88d;">"music"</span>: <span style="color: #c3e88d;">"bach"</span>, <span style="color: #c3e88d;">"art"</span>: <span style="color: #c3e88d;">"davinci"</span>}
<span style="color: #ffcb6b;">uservals</span> <span style="color: #89DDFF;">=</span> {}
<span style="color: #ffcb6b;">mapping</span> <span style="color: #89DDFF;">=</span> <span style="color: #c792ea; font-weight: bold;">ChainMap</span>(uservals, defaults)
<span style="color: #82aaff; font-weight: bold;">print</span>(mapping)
</pre>
</div>

<pre class="example">
ChainMap({}, {'color': 'red', 'user': 'guest', 'music': 'bach', 'art': 'davinci'})
</pre>


<div class="org-src-container">
<pre class="src src-jupyter-python"><span style="color: #89DDFF;">def</span> <span style="color: #82aaff;">print_map</span>(<span style="color: #ffcb6b;">mapping</span>):
    <span style="color: #89DDFF;">for</span> <span style="color: #ffcb6b;">k</span>, <span style="color: #ffcb6b;">v</span> <span style="color: #89DDFF;">in</span> mapping.<span style="color: #c792ea; font-weight: bold; font-style: italic;">items</span>():
        <span style="color: #82aaff; font-weight: bold;">print</span>(<span style="color: #c3e88d;">f"</span><span style="color: #89DDFF;">{</span><span style="color: #EEFFFF; background-color: #212121;">k</span><span style="color: #89DDFF;">}</span><span style="color: #c3e88d;">: </span><span style="color: #89DDFF;">{</span><span style="color: #EEFFFF; background-color: #212121;">v</span><span style="color: #89DDFF;">}</span><span style="color: #c3e88d;">"</span>)

<span style="color: #c792ea; font-weight: bold;">print_map</span>(mapping)
</pre>
</div>

<pre class="example">
color: red
user: guest
music: bach
art: davinci
</pre>


<p>
When we add a new key-value pair, it gets added into the first mapping.
</p>
<div class="org-src-container">
<pre class="src src-jupyter-python">mapping[<span style="color: #ffcb6b;">"sport"</span>] <span style="color: #89DDFF;">=</span> <span style="color: #c3e88d;">"football"</span>
<span style="color: #82aaff; font-weight: bold;">print</span>(mapping)
<span style="color: #c792ea; font-weight: bold;">print_map</span>(mapping)
</pre>
</div>

<pre class="example">
ChainMap({'sport': 'football'}, {'color': 'red', 'user': 'guest', 'music': 'bach', 'art': 'davinci'})
color: red
user: guest
music: bach
art: davinci
sport: football
</pre>


<p>
On updating an existing value, the first mapping gets a new value and hence,
when we access the value, it returns the new value.
</p>
<div class="org-src-container">
<pre class="src src-jupyter-python">mapping[<span style="color: #ffcb6b;">"music"</span>] <span style="color: #89DDFF;">=</span> <span style="color: #c3e88d;">"mozart"</span>
<span style="color: #82aaff; font-weight: bold;">print</span>(mapping)
<span style="color: #c792ea; font-weight: bold;">print_map</span>(mapping)
</pre>
</div>

<pre class="example">
ChainMap({'sport': 'football', 'music': 'mozart'}, {'color': 'red', 'user': 'guest', 'music': 'bach', 'art': 'davinci'})
color: red
user: guest
music: mozart
art: davinci
sport: football
</pre>


<p>
It also allows using the dictionary methods like <code>update()</code> to perform bulk
updates.
</p>
<div class="org-src-container">
<pre class="src src-jupyter-python">mapping.<span style="color: #c792ea; font-weight: bold; font-style: italic;">update</span>({<span style="color: #c3e88d;">"music"</span>: <span style="color: #c3e88d;">"beethoven"</span>, <span style="color: #c3e88d;">"art"</span>: <span style="color: #c3e88d;">"boticelli"</span>})
<span style="color: #82aaff; font-weight: bold;">print</span>(mapping)
<span style="color: #c792ea; font-weight: bold;">print_map</span>(mapping)
</pre>
</div>

<pre class="example">
ChainMap({'sport': 'football', 'music': 'beethoven', 'art': 'boticelli'}, {'color': 'red', 'user': 'guest', 'music': 'bach', 'art': 'davinci'})
color: red
user: guest
music: beethoven
art: boticelli
sport: football
</pre>


<p>
If we want to delete the updates to the mapping, we can simply use <code>del</code>.
</p>
<div class="org-src-container">
<pre class="src src-jupyter-python"><span style="color: #89DDFF;">del</span> mapping[<span style="color: #c3e88d;">"music"</span>]
<span style="color: #82aaff; font-weight: bold;">print</span>(mapping)
<span style="color: #c792ea; font-weight: bold;">print_map</span>(mapping)
</pre>
</div>

<pre class="example">
ChainMap({'sport': 'football', 'art': 'boticelli'}, {'color': 'red', 'user': 'guest', 'music': 'bach', 'art': 'davinci'})
color: red
user: guest
music: bach
art: boticelli
sport: football
</pre>


<div class="org-src-container">
<pre class="src src-python">    <span style="color: #89DDFF;">def</span> <span style="color: #82aaff;">__delitem__</span>(<span style="color: #89DDFF;">self</span>, <span style="color: #ffcb6b;">key</span>):
        <span style="color: #89DDFF;">try</span>:
            <span style="color: #89DDFF;">del</span> <span style="color: #89DDFF;">self</span>.<span style="color: #F78C6C; font-style: italic;">maps</span>[<span style="color: #F78C6C;">0</span>][key]
        <span style="color: #89DDFF;">except</span> <span style="color: #c792ea;">KeyError</span>:
            <span style="color: #89DDFF;">raise</span> <span style="color: #c792ea; font-weight: bold;">KeyError</span>(<span style="color: #c3e88d;">f'Key not found in the first mapping: </span><span style="color: #89DDFF;">{</span><span style="color: #EEFFFF; background-color: #212121;">key!r</span><span style="color: #89DDFF;">}</span><span style="color: #c3e88d;">'</span>)
</pre>
</div>
<p>
An important thing to note is that <code>del</code> will delete the key only from the first
mapping, so the defaults remain consistent through writes and deletes. For
example, the following code will raise an error since after the first delete,
the <code>"music"</code> key is not present in the first mapping.
</p>
<div class="org-src-container">
<pre class="src src-jupyter-python"><span style="color: #89DDFF;">del</span> mapping[<span style="color: #c3e88d;">"music"</span>]
<span style="color: #89DDFF;">del</span> mapping[<span style="color: #c3e88d;">"music"</span>]
</pre>
</div>

<pre class="example" id="orga4869e4">
---------------------------------------------------------------------------
KeyError                                  Traceback (most recent call last)
File /usr/lib/python3.10/collections/__init__.py:1042, in ChainMap.__delitem__(self, key)
   1041 try:
-&gt; 1042     del self.maps[0][key]
   1043 except KeyError:

KeyError: 'music'

During handling of the above exception, another exception occurred:

KeyError                                  Traceback (most recent call last)
Cell In[22], line 1
----&gt; 1 del mapping["music"]
      2 del mapping["music"]

File /usr/lib/python3.10/collections/__init__.py:1044, in ChainMap.__delitem__(self, key)
   1042     del self.maps[0][key]
   1043 except KeyError:
-&gt; 1044     raise KeyError(f'Key not found in the first mapping: {key!r}')

KeyError: "Key not found in the first mapping: 'music'"
</pre>

<p>
We can also update the underlying maps directly. As we see, we can add a mapping
easily by setting the maps to a new list.
</p>
<div class="org-src-container">
<pre class="src src-jupyter-python"><span style="color: #82aaff; font-weight: bold;">print</span>(mapping.<span style="color: #F78C6C; font-style: italic;">maps</span>)
mapping.<span style="color: #ffcb6b; font-style: italic;">maps</span> <span style="color: #89DDFF;">=</span> [{}, <span style="color: #89DDFF;">*</span>mapping.<span style="color: #F78C6C; font-style: italic;">maps</span>]
<span style="color: #82aaff; font-weight: bold;">print</span>(mapping.<span style="color: #F78C6C; font-style: italic;">maps</span>)
</pre>
</div>

<pre class="example">
[{'sport': 'football'}, {'color': 'red', 'user': 'guest', 'music': 'bach', 'art': 'davinci'}]
[{}, {'sport': 'football'}, {'color': 'red', 'user': 'guest', 'music': 'bach', 'art': 'davinci'}]
</pre>
</div>
<div id="postamble" class="status">
<hr/>
<footer>
<div class="generated">
Created with <a href="https://www.gnu.org/software/emacs/">Emacs</a> 28.2 (<a href="https://orgmode.org">Org</a> mode 9.6.1)
</div>
</footer>
</div>
</body>
</html>